import telebot
from telebot import types

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏–∑ @BotFather
API_TOKEN = '7980360709:AAGmJe0Bj1JtL2QSzyMbBrFWmMWtEc5Otqo'

# –Æ–∑–µ—Ä–Ω–µ–π–º –Ω–æ–≤–æ—Å—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å @)
CHANNEL_ID = '@SlizenTapTapNews' 

# –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à—É –∏–≥—Ä—É, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é –Ω–∞ GitHub Pages
MINI_APP_URL = 'https://banditgeniy-dot.github.io/-SlizenBOT/'

bot = telebot.TeleBot(API_TOKEN)

def is_subscribed(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–∞–Ω–∞–ª."""
    try:
        member = bot.get_chat_member(CHANNEL_ID, user_id)
        print(f"[DEBUG] –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {member.status}")
        if member.status in ['member', 'administrator', 'creator']:
            return True
        return False
    except Exception as e:
        print(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏: {e}")
        return False

@bot.message_handler(commands=['start'])
def start_handler(message):
    user_id = message.from_user.id
    first_name = message.from_user.first_name
    
    print(f"[INFO] –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –°–¢–ê–†–¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {first_name}")

    if is_subscribed(user_id):
        # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω ‚Äî –¥–∞–µ–º –∫–Ω–æ–ø–∫—É –∏–≥—Ä—ã
        markup = types.InlineKeyboardMarkup()
        web_app = types.WebAppInfo(MINI_APP_URL)
        btn_play = types.InlineKeyboardButton('–ò–≥—Ä–∞—Ç—å –≤ –°–ª–∏–∑–Ω—è üíß', web_app=web_app)
        markup.add(btn_play)
        
        bot.send_message(
            message.chat.id,
            f"–ü—Ä–∏–≤–µ—Ç, {first_name}! –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞. –ñ–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!",
            reply_markup=markup
        )
    else:
        # –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω ‚Äî —Ç—Ä–µ–±—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        markup = types.InlineKeyboardMarkup()
        btn_channel = types.InlineKeyboardButton('–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ù–æ–≤–æ—Å—Ç–∏ üì¢', url=f"https://t.me/SlizenTapTapNews")
        btn_check = types.InlineKeyboardButton('–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è ‚úÖ', callback_data='verify_sub')
        markup.add(btn_channel)
        markup.add(btn_check)
        
        bot.send_message(
            message.chat.id,
            f"–ü—Ä–∏–≤–µ—Ç, {first_name}! –ß—Ç–æ–±—ã –≤–æ–π—Ç–∏ –≤ –∏–≥—Ä—É, –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –∫–∞–Ω–∞–ª.",
            reply_markup=markup
        )

@bot.callback_query_handler(func=lambda call: call.data == 'verify_sub')
def callback_verify(call):
    if is_subscribed(call.from_user.id):
        bot.answer_callback_query(call.id, "–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω! ‚úÖ")
        bot.delete_message(call.message.chat.id, call.message.message_id)
        start_handler(call)
    else:
        bot.answer_callback_query(call.id, "–í—ã –µ—â–µ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å! ‚ùå", show_alert=True)

if __name__ == '__main__':
    print("--- –ë–æ—Ç SlizenTapBOT –∑–∞–ø—É—â–µ–Ω ---")
    bot.polling(none_stop=True)